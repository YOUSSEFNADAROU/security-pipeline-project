name: Security Tests Pipeline
on: [push, pull_request]  # Se lance sur push ET pull request

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¦ Installer Docker
        run: |
          echo "Installation de Docker..."
          sudo apt-get update
          
      - name: ğŸš€ Lancer Juice Shop (comme Imane)
        run: |
          echo "Lancement de Juice Shop..."
          docker run -d -p 3000:3000 --name juice-shop bkimminich/juice-shop
          sleep 30  # Attendre que Ã§a dÃ©marre
          echo "Juice Shop devrait Ãªtre sur http://localhost:3000"

  dast-tests:
    needs: setup-environment  # Attendre que Juice Shop soit lancÃ©
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ” Installer OWASP ZAP
        run: |
          echo "Installation de ZAP..."
          docker pull owasp/zap2docker-stable
          
      - name: ğŸ¯ Lancer le scan DAST (comme dans le rapport)
        run: |
          echo "Lancement du scan automatisÃ©..."
          docker run --rm \
            --network host \
            owasp/zap2docker-stable \
            zap-baseline.py -t http://localhost:3000 -J report.json
          
      - name: ğŸ“Š GÃ©nÃ©rer le rapport
        run: |
          echo "GÃ©nÃ©ration du rapport simple..."
          echo "# Rapport DAST AutomatisÃ©" > report.md
          echo "Date: $(date)" >> report.md
          echo "BasÃ© sur le travail d'Imane" >> report.md
          echo "VulnÃ©rabilitÃ©s attendues: 9" >> report.md
          echo "PrioritÃ© 1: Injection SQL sur /rest/user/login" >> report.md
          
      - name: ğŸ“¤ Sauvegarder le rapport
        uses: actions/upload-artifact@v4
        with:
          name: dast-report
          path: report.md
