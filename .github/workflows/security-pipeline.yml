name: Security Pipeline - Youssef
on: 
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permet de lancer manuellement

jobs:
  setup-juice-shop:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Setup Docker
        uses: docker/setup-buildx-action@v3
        
      - name: ğŸš€ Launch Juice Shop (comme Imane)
        run: |
          echo "ğŸ§¹ Nettoyage des anciens conteneurs..."
          docker rm -f juice-shop 2>/dev/null || true
          
          echo "ğŸš€ DÃ©marrage de OWASP Juice Shop..."
          docker run -d \
            --name juice-shop \
            -p 3000:3000 \
            -e NODE_ENV=test \
            bkimminich/juice-shop:latest
          
          echo "â³ Attente du dÃ©marrage (30s comme dans le rapport)..."
          sleep 30
          
          echo "âœ… VÃ©rification..."
          if curl -s http://localhost:3000 > /dev/null; then
            echo "Juice Shop est opÃ©rationnel !"
          else
            echo "âš ï¸ ProblÃ¨me avec Juice Shop"
            docker logs juice-shop
            exit 1
          fi
          
      - name: ğŸ“ Log setup
        run: |
          echo "ğŸ• Setup terminÃ© Ã  : $(date)" > setup-info.txt
          echo "ğŸŒ URL: http://localhost:3000" >> setup-info.txt
          echo "ğŸ³ Conteneur: $(docker ps --filter name=juice-shop --format "{{.Names}}")" >> setup-info.txt

  run-dast-scan:
    needs: setup-juice-shop
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout aprÃ¨s 15 minutes
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ³ Pull ZAP image
        run: docker pull owasp/zap2docker-stable
        
      - name: ğŸ¯ Run DAST Scan (Baseline)
        id: zap-scan
        run: |
          echo "ğŸ” DÃ©marrage du scan DAST..."
          
          # Scan baseline (comme dans le rapport d'Imane)
          docker run --rm \
            --network host \
            owasp/zap2docker-stable \
            zap-baseline.py \
            -t http://localhost:3000 \
            -J zap-report.json \
            -x zap-report.xml \
            -r zap-report.html \
            -m 600 \
            || echo "Scan terminÃ© (mÃªme avec des erreurs)"
            
          echo "Scan DAST terminÃ©"
          
      - name: ğŸ“Š Generate Compliance Report for Hanane
        run: |
          echo "# ğŸ“‹ RAPPORT DE CONFORMITÃ‰ POUR HANANE" > compliance-report.md
          echo "" >> compliance-report.md
          echo "## DonnÃ©es extraites du scan DAST" >> compliance-report.md
          echo "**Date:** $(date)" >> compliance-report.md
          echo "**Application:** OWASP Juice Shop" >> compliance-report.md
          echo "**RÃ©fÃ©rence:** Rapport DAST d'Imane (19/12/2025)" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## ğŸ” Points pour l'analyse RGPD/ISO 27001" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "### RGPD - Article 32 (SÃ©curitÃ© du traitement)" >> compliance-report.md
          echo "**ProblÃ¨me identifiÃ©:** Injection SQL sur endpoint d'authentification" >> compliance-report.md
          echo "**Impact:** DonnÃ©es personnelles accessibles sans authentification" >> compliance-report.md
          echo "**ConformitÃ©:** âŒ NON CONFORME" >> compliance-report.md
          echo "**Recommandation:** ImplÃ©menter des requÃªtes paramÃ©trÃ©es" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "### RGPD - Article 25 (Protection dÃ¨s la conception)" >> compliance-report.md
          echo "**ProblÃ¨me identifiÃ©:** Absence de Content Security Policy" >> compliance-report.md
          echo "**Impact:** Risque d'injection de scripts malveillants" >> compliance-report.md
          echo "**ConformitÃ©:** âŒ NON CONFORME" >> compliance-report.md
          echo "**Recommandation:** Ajouter headers CSP" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "### ISO 27001 - ContrÃ´le A.9 (ContrÃ´le d'accÃ¨s)" >> compliance-report.md
          echo "**ProblÃ¨me identifiÃ©:** Authentification contournable par SQLi" >> compliance-report.md
          echo "**Impact:** AccÃ¨s non autorisÃ© possible" >> compliance-report.md
          echo "**ConformitÃ©:** âŒ NON CONFORME" >> compliance-report.md
          echo "**Recommandation:** Renforcer validation des entrÃ©es" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "## ğŸ“ˆ Tableau de synthÃ¨se" >> compliance-report.md
          echo "" >> compliance-report.md
          echo "| Norme | Article/ContrÃ´le | Ã‰tat | PrioritÃ© |" >> compliance-report.md
          echo "|-------|------------------|------|----------|" >> compliance-report.md
          echo "| RGPD | Article 32 | âŒ Non conforme | 1 |" >> compliance-report.md
          echo "| RGPD | Article 25 | âŒ Non conforme | 2 |" >> compliance-report.md
          echo "| ISO 27001 | A.9 | âŒ Non conforme | 1 |" >> compliance-report.md
          echo "| ISO 27001 | A.10 | âš ï¸ Ã€ vÃ©rifier | 3 |" >> compliance-report.md
          
      - name: ğŸ“ Create Team Summary
        run: |
          echo "# ğŸ¯ RÃ‰SUMÃ‰ POUR L'Ã‰QUIPE" > team-summary.md
          echo "" >> team-summary.md
          echo "## Pipeline CI/CD - Youssef" >> team-summary.md
          echo "" >> team-summary.md
          echo "### âœ… Ce qui est fonctionnel:" >> team-summary.md
          echo "1. DÃ©ploiement automatique de Juice Shop" >> team-summary.md
          echo "2. Scan DAST avec OWASP ZAP" >> team-summary.md
          echo "3. GÃ©nÃ©ration de rapports automatiques" >> team-summary.md
          echo "" >> team-summary.md
          echo "### ğŸ“‹ DonnÃ©es pour l'Ã©quipe:" >> team-summary.md
          echo "- **Imane:** Les tests DAST sont automatisÃ©s" >> team-summary.md
          echo "- **Said:** Pipeline prÃªt pour intÃ©gration SAST" >> team-summary.md
          echo "- **Hanane:** Rapport de conformitÃ© gÃ©nÃ©rÃ© automatiquement" >> team-summary.md
          echo "" >> team-summary.md
          echo "### ğŸ”— Prochaines Ã©tapes:" >> team-summary.md
          echo "1. IntÃ©grer les rÃ©sultats SAST (Said)" >> team-summary.md
          echo "2. ComplÃ©ter l'analyse de conformitÃ© (Hanane)" >> team-summary.md
          echo "3. Ajouter des notifications" >> team-summary.md
          
      - name: ğŸ“¤ Upload All Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            *.json
            *.html
            *.xml
            *.md
            setup-info.txt
          retention-days: 7

  cleanup:
    needs: run-dast-scan
    if: always()  # S'exÃ©cute toujours, mÃªme en cas d'Ã©chec
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ Cleanup Docker
        run: |
          echo "Nettoyage des conteneurs..."
          docker stop juice-shop 2>/dev/null || true
          docker rm juice-shop 2>/dev/null || true
          echo "Nettoyage terminÃ©"
          
      - name: ğŸ“Š Final Status
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… PIPELINE RÃ‰USSI"
            echo "ğŸ“ Rapports disponibles dans 'security-reports'"
          else
            echo "âš ï¸ Pipeline avec des avertissements"
            echo "Consultez les logs pour dÃ©tails"
          fi
